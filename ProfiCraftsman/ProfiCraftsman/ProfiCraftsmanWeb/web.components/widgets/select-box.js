define(["lr!widgets/resources/select-box","text!widgets/templates/select-box.html"],function(e,t){"use strict";$.widget("custom.selectBox",{options:{allowToSelectAll:!0,selectAllItemsText:e.selectAllItemsText,placeholder:e.placeholder},values:function(){var e=[];return this.element.find("option").each(function(t,o){$(o).is(":selected")&&e.push(Number($(o).val()))}),e},destroy:function(){this._onBodyClick&&($("body").off("click",this._onBodyClick),this._onBodyClick=null),this.$popupContainer&&(this.$popupContainer.remove(),this.$popupContainer=null)},_create:function(){var e=this,t=e._template();e.options=_.defaults({placeholder:e.element.data("placeholder"),allowToSelectAll:e.element.data("allow-to-select-all"),selectAllItemsText:e.element.data("select-all-items-text")},e.options),e.$select=e.element.attr("multiple","multiple"),e.$wrapperContainer=$(t).filter("span"),e.$wrapper=e.$wrapperContainer.find(".k-dropdown-wrap"),e.$popupContainer=$(t).filter("div"),e.$popup=e.$popupContainer.find(".popup"),e.$selectButton=e.$wrapper.find(".k-select"),e.$ul=e.$popup.find("ul"),e.$textBox=e.$wrapper.find(".k-input").attr("placeholder",e.options.placeholder),e.$select.after(e.$wrapperContainer).detach().appendTo(e.$wrapperContainer).hide(),$(document.body).append(e.$popupContainer),_.isArray(e.options.dataSource)&&(e.$select.empty(),_.each(e.options.dataSource,function(t){e.$select.append('<option value="'+t[e.options.dataValueField]+'" >'+t[e.options.dataTextField]+"</option>")})),e._renderItems(),e.options.allowToSelectAll&&e._renderAllItem(),e.restore(),e._subscribe()},_template:function(){var o=o={id:this.element.attr("name"),okText:e.okText,cancelText:e.cancelText};return _.template(t)(o)},_subscribe:function(){var e=this;this.$wrapper.hover(function(){e.$wrapper.addClass("k-state-hover")},function(){e.$wrapper.removeClass("k-state-hover")}),this.$ul.find("li").hover(function(e){$(e.target).addClass("k-state-hover")},function(e){$(e.target).removeClass("k-state-hover")}),this.$ul.delegate("li, :checkbox","click",function(t){t.stopPropagation();var o=$(t.target),n=o.is(":checkbox")?o:o.find(":checkbox");n!==o&&n.prop("checked",!n.is(":checked")),n.is(".all")?e.$checkBoxes.prop("checked",e.$checkBoxAll.is(":checked")):e.$checkBoxAll.prop("checked",e.$checkBoxes.length==e.$checkBoxes.filter(":checked").length)}),this.$popupContainer.mousedown(function(e){e.stopPropagation(),e.preventDefault()}).click(function(e){e.stopPropagation(),e.preventDefault()}),this.$selectButton.mousedown(function(e){e.stopPropagation(),e.preventDefault()}).click(function(e){e.stopPropagation(),e.preventDefault()}),this.$textBox.focus(function(){e.$wrapper.addClass("k-state-focused")}).blur(function(){e.$wrapper.removeClass("k-state-focused")}),this.$selectButton.click(function(t){t.stopPropagation(),t.preventDefault(),e._togglePopup(),e._ensureFocus()}),this.$popup.find("a:first").click(function(){e._save(),e.$select.trigger("change"),e._togglePopup(!1),e._ensureFocus()}),this.$popup.find("a:last").click(function(){e.restore(),e._togglePopup(!1),e._ensureFocus()}),this._onBodyClick=function(t){$(t.srcElement||t.target).parents("#"+e.element.attr("name")+"_popup").length||e._togglePopup(!1)},$("body").on("click",this._onBodyClick)},_renderItems:function(){var e=this;e.$select.find("option").each(function(t,o){{var n=$(o),i=n.val(),p=n.text(),s=$('<li class="k-item">'+p+"</li>");$('<input type="checkbox" value="'+i+'"/>').prependTo(s)}e.$ul.append(s)}),e.$checkBoxes=e.$ul.find(":checkbox")},_renderAllItem:function(){var e=$('<li class="k-item">'+this.options.selectAllItemsText+"</li>").prependTo(this.$ul),t=$('<input class="all" type="checkbox" />').prependTo(e);this.$checkBoxAll=t},_save:function(){var e=this,t=[],o=[];e.$ul.find(":checked:not(.all)").each(function(e,o){t.push($(o).val())}),e.$select.find("option").each(function(e,n){var i=_.contains(t,$(n).val());$(n).prop("selected",i),i&&o.push($(n).text())}),e._setText(o)},restore:function(){var e=this,t=[],o=[];e.$select.find("option:selected").each(function(e,n){t.push($(n).val()),o.push($(n).text())});var n=e.$ul.find(":checkbox:not(.all)").each(function(e,o){$(o).attr("checked",_.contains(t,$(o).val()))});e.$ul.find(".all").prop("checked",n.length==n.filter(":checked").length),e._setText(o)},_setText:function(e){var t=e.join("; "),o=e.join("[br] [checkbox] ");o&&(o="[checkbox] "+o),this.$textBox.val(t),this.$textBox.attr("title",o)},_ensureFocus:function(){this.$popupContainer.is(":visible")?this.$wrapper.removeClass("k-state-focused"):this.$textBox.focus()},_togglePopup:function(e){this.$popupContainer.toggle(e),this._measurePopupSizeAndPosition()},_measurePopupSizeAndPosition:function(){var e=this.$popupContainer.outerHeight();e>200&&(e=200,this.$popupContainer.find("ul").css({height:"200px","overflow-y":"scroll"}));var t=this.$wrapperContainer.offset().top,o=$(window).outerHeight(),n=$(window).outerWidth(),i=window.pageYOffset,p=this.$wrapperContainer.outerWidth(),s=this.$wrapperContainer.offset().left;this.$popup.removeClass("border-up border-down"),t-i+e>o?(this.$popupContainer.css("top",t-this.$popup.outerHeight()-1),this.$popup.addClass("border-down")):(this.$popupContainer.css("top",t+this.$wrapperContainer.outerHeight()+1),this.$popup.addClass("border-up")),190>p&&(p=190),s+p>n&&(s-=s+p-n),this.$popupContainer.css("left",s),this.$popupContainer.css("width",p+"px")}})});